@model IEnumerable<TestApp.DB.Branch>

@{
    Layout = "~/Views/Shared/_LayoutPage_New.cshtml";
    ViewBag.Title = "Branch Management";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-building me-2"></i>Branch Management
                        </h4>
                        <div class="btn-group">
                            <a href="@Url.Action("CreateBranch_New", "Staff")" class="btn btn-light btn-sm">
                                <i class="fas fa-plus me-1"></i>Add Branch
                            </a>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="exportData()">
                                <i class="fas fa-file-excel me-1"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model != null && Model.Any())
                    {
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-building fa-2x mb-2"></i>
                                        <h4>@Model.Count()</h4>
                                        <p class="mb-0">Total Branches</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                        <h4>@Model.Select(b => b.City).Distinct().Count()</h4>
                                        <p class="mb-0">Cities</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-flag fa-2x mb-2"></i>
                                        <h4>@Model.Select(b => b.State).Distinct().Count()</h4>
                                        <p class="mb-0">States</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-tie fa-2x mb-2"></i>
                                        <h4>@Model.Count(b => b.ManagerID != null)</h4>
                                        <p class="mb-0">With Manager</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search branches...">
                                    <small class="text-muted mt-1" id="resultCount">Showing all branches</small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilter()">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="branchTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Branch ID</th>
                                        <th>Code</th>
                                        <th>Branch Name</th>
                                        <th>Open Date</th>
                                        <th>Address</th>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>PIN Code</th>
                                        <th>Manager ID</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var branch in Model)
                                    {
                                        <tr>
                                            <td>@branch.BranchID</td>
                                            <td>
                                                <span class="badge bg-primary">@branch.BranchCode</span>
                                            </td>
                                            <td>
                                                <div class="fw-bold">@(branch.BranchName ?? "Unknown")</div>
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(branch.OpenDate))
                                                {
                                                    <span class="text-muted">@branch.OpenDate</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Not set</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 200px;" title="@branch.BAddress">
                                                    @(string.IsNullOrEmpty(branch.BAddress) ? "Not provided" : branch.BAddress)
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">@(branch.City ?? "Unknown")</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">@(branch.State ?? "Unknown")</span>
                                            </td>
                                            <td>
                                                <code class="bg-light text-dark px-2 py-1 rounded">
                                                    @(branch.PinCode != null ? branch.PinCode.ToString() : "000000")
                                                </code>
                                            </td>
                                            <td>
                                                @if (branch.ManagerID.HasValue)
                                                {
                                                    <span class="badge bg-success">@branch.ManagerID</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">Not Assigned</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewBranch(@branch.BranchID)" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="editBranch(@branch.BranchID, '@branch.BranchName', '@branch.BranchCode')" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBranch(@branch.BranchID, '@branch.BranchName')" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-building fa-4x text-muted mb-3"></i>
                            <h5>No Branches Found</h5>
                            <p class="text-muted">No branch data available to display.</p>
                            <a href="@Url.Action("CreateBranch_New", "Staff")" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add First Branch
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log('BranchList functionality loaded');
    
    // Search functionality
    $('#searchInput').on('keyup input', function() {
        filterTable();
    });
});

function filterTable() {
    var input, filter, table, tr, td, i, j, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("branchTable");
    tr = table.getElementsByTagName("tr");
    var visibleRows = 0;

    for (i = 1; i < tr.length; i++) {
        tr[i].style.display = "none";
        td = tr[i].getElementsByTagName("td");
        for (j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    visibleRows++;
                    break;
                }
            }
        }
    }
    
    console.log('Filtered results:', visibleRows, 'rows visible');
    
    // Update result counter
    var resultText = visibleRows === 1 ? 'Showing 1 branch' : 'Showing ' + visibleRows + ' branches';
    document.getElementById('resultCount').textContent = resultText;
}

function clearFilter() {
    document.getElementById("searchInput").value = "";
    filterTable();
    document.getElementById('resultCount').textContent = 'Showing all branches';
}

function exportData() {
    alert("Export functionality will be implemented soon!");
}

function viewBranch(id) {
    alert("View branch " + id + " - functionality to be implemented");
}

function editBranch(id, name, code) {
    alert("Edit branch " + name + " (ID: " + id + ") - functionality to be implemented");
}

function deleteBranch(id, name) {
    if (confirm("Are you sure you want to delete branch '" + name + "'?")) {
        alert("Delete branch " + name + " (ID: " + id + ") - functionality to be implemented");
    }
}
</script>
}

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
    font-weight: 600;
}

.badge {
    font-size: 0.875em;
}

.btn-group .btn {
    border-radius: 0.25rem;
    margin: 0 1px;
}

@@media (max-width: 768px) {
    .container-fluid {
        padding: 10px;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
