@model TestApp.VModels.Loans.LoanDisbus
@{
    ViewBag.Title = "Loans";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}
<!DOCTYPE>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>Create Branch</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>  
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js">  
    </script> 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>  
  <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css'>
  <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css'>
  <link rel='stylesheet prefetch' href='http://cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/css/bootstrapValidator.min.css'>
  <link rel="stylesheet" href="css/style.css">  
     <style>
         .drpdwn {
             width: 43px;
             height: 30px;
         }
     </style>
</head>   
<body>
  
      <div class="container" ;border-color: "darkgrey";border-width:"2px";">
           
          @using (Html.BeginForm("LoansDisbus", "Loans", FormMethod.Post, htmlAttributes: new { @class = "well form-horizontal", @id = "myform" }))
          {              
                @Html.HiddenFor(model => model.Date_Of_Disbursement, new { @id = "DOD" })
          <label id="lblmgs"></label>
              //@Html.ValidationSummary(false, "", new { @id = "Errors", @class = "text-danger" }) 
<fieldset>     
    <!-- Form Name -->
<legend><h2><b>Loan Disbursement</b></h2><br>
     
         <div style="float:left;margin-top: 1%;"> <label >Select Group Name&nbsp</label>@Html.DropDownListFor(x => Model.GrpCodeList, new SelectList(Model.GrpCodeList, "Value", "Text"), "--All Groups--", htmlAttributes: new { @class = "btn btn-primary", @style = "width: 150px;", @id = "GrpCode" })&nbsp
            <label >Select Member Name&nbsp</label>@Html.DropDownListFor(x => Model.MbrList, new SelectList(Model.MbrList, "Value", "Text"), "--All Members--", htmlAttributes: new { @class = "btn btn-primary", @style = "width: 150px;", @id = "drMbrId" })
       </div> <br /> <br /> <br /> 
 </legend>

<!-- Mbr ID -->
<div class="form-group">
  <label class="col-md-2 control-label">Member ID</label>  
  <div class="col-md-3 inputGroupContainer">
  <div class="input-group">
  <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
      @Html.TextBoxFor(model => model.MbrId, new { @class = "form-control", @Value = "0", @readonly = "readonly", @placeholder = "Member ID", @required = "required", @id = "MbrID" })
    </div>
  </div>
</div>

<!-- Loan_Amount Code-->
<div class="form-group">
  <label class="col-md-2 control-label">Loan Amount</label>  
  <div class="col-md-3 inputGroupContainer">
  <div class="input-group">
  <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
      @Html.TextBoxFor(model => model.Loan_Amount, new { @class = "form-control", @Value = "0.00", @placeholder = "Loan Amount", @required = "required", @id = "Loan_Amount" })
    </div>
  </div>

    <label class="col-md-2 control-label" >No Of Days/Weeks</label> 
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
  <span class="input-group-addon"><i class="fa fa-hourglass-2"></i></span>
        @Html.TextBoxFor(model => model.NoOfDays, new { @class = "form-control", @placeholder = "No Of Days", @required = "required", @id = "NoOfDays" })
    </div>
  </div>
</div>
    <!-- NoOfDays Name-->
<div class="form-group">
    
  <label class="col-md-2 control-label" >Disbursement Date</label> 
     <div class="col-md-3 selectContainer">
    <div class="input-group">
        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span> 
         <input class = "form-control", required = "required" value="@Model.Date_Of_Disbursement" type="text" id="idDOD">
      @*  @Html.DropDownListFor(x => Model.CrD, Enumerable.Range(1, 31).Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }), "DD", htmlAttributes: new { @class = "drpdwn", @id = "D", @required = "required" })&nbsp&nbsp;
         @Html.DropDownListFor(x => Model.CrM, Enumerable.Range(1, 12).Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }), "MM", htmlAttributes: new { @class = "drpdwn", @id = "M", @required = "required" })&nbsp&nbsp;
         @Html.DropDownListFor(x => Model.CrY, Enumerable.Range(2015, Convert.ToInt32(DateTime.Now.Year - 2015 + 1)).Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }), "YYYY", htmlAttributes: new { @class = "drpdwn", @id = "Y", @required = "required" })*@
    </div>
  </div>


     <label class="col-md-2 control-label">Prin EMI</label>  
  <div class="col-md-3 inputGroupContainer">
  <div class="input-group">
  <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
       @Html.TextBoxFor(model => model.Prin_EMI, new { @class = "form-control", @Value = "0.00", @placeholder = "Prin EMI", @required = "required", @id = "Prin_EMI" })
    </div>
  </div>

    </div>
   
<div class="form-group">

    


   <!-- Int_EMI -->
  <label class="col-md-2 control-label">Total Interest Amount</label>
    <div class="col-md-3 selectContainer">
    <div class="input-group">
               <span class="input-group-addon"><i  class="fa fa-percent"></i></span> 
          @Html.TextBoxFor(model => model.RateOfInterest, new { @class = "form-control", @Value = "0.00", @placeholder = "Int EMI", @required = "required", @id = "RateOfInterest" })
        @*@Html.DropDownListFor(x => Model.CrD, Enumerable.Range().Select(i => new SelectListItem { Value = i.ToString(), Text = i.ToString() }), "Select Rate", htmlAttributes: new { @class = "drpdwn", @id = "IntRates" })&nbsp&nbsp;*@
  </div>
</div>

    <!-- Expiry_Date-->
  <label class="col-md-2 control-label" >End Date</label> 
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
  <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
        @Html.TextBoxFor(model => model.Expiry_Date, new { @class = "form-control", @placeholder = "End Date", @required = "required", @id = "Expiry_Date" })
    </div>
  </div>

</div>

<div class="form-group">
<!-- Processing_Fee-->
  <label class="col-md-2 control-label">Processing Fee</label>  
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
        <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
      @Html.TextBoxFor(model => model.Processing_Fee, new { @class = "form-control", @Value = "0.00", @placeholder = "Processing Fee", @id = "Processing_Fee" })
    </div>
  </div>
    <!--GRFAmt-->

  <label class="col-md-2 control-label">GRF Amount</label>  
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
        <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
      @Html.TextBoxFor(model => model.GRFAmt, new { @class = "form-control", @Value = "0.00", @placeholder = "GRF Amount", @id = "GRFAmt" })
    </div>
  </div>
</div>

    <!--Member Address-->
<div class="form-group"> 
  @*<label class="col-md-2 control-label">ALR Amount</label>  
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
        <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
      @Html.TextBoxFor(model => model.ALRAmt, new { @class = "form-control", @Value = "0.00", @placeholder = "ALR Amount", @required = "required", @id = "ALRAmt" })
    </div>
  </div>*@

               <!-- Loan Type -->
  <label class="col-md-2 control-label">Loan Type</label>
    <div class="col-md-3 selectContainer">
    <div class="input-group">
               <span class="input-group-addon"><i class="fa fa-check"></i></span>
          @Html.DropDownListFor(model => model.LoanType, new List<SelectListItem> { new SelectListItem { Value = "General", Text = "General" }, new SelectListItem { Value = "Special", Text = "Special" } }, "-Select Loan Type-", new { @class = "form-control", @required = "required", @id = "LoanType" })
  </div>
</div>

           <!-- Other_Income -->
  <label class="col-md-2 control-label">Other Income</label>
    <div class="col-md-3 selectContainer">
    <div class="input-group">
               <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
          @Html.TextBoxFor(model => model.Other_Income, new { @class = "form-control", @Value = "0.00", @placeholder = "Other Income", @id = "Other_Income" })
  </div>
</div>
</div>



<div class="form-group">
       <!-- Insurance -->

  <label class="col-md-2 control-label">Insurance</label>
    <div class="col-md-3 selectContainer">
    <div class="input-group">
               <span class="input-group-addon"><i class="fa fa-rupee"></i></span>
          @Html.TextBoxFor(model => model.Insurance, new { @class = "form-control", @Value = "0.00", @placeholder = "Insurance", @id = "Insurance" })
  </div>
    </div>

      <label class="col-md-2 control-label">Next Due Date</label>  
    <div class="col-md-3 inputGroupContainer">
    <div class="input-group">
        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
      @Html.TextBoxFor(model => model.NextDueDt, new { @class = "form-control", @placeholder = "NextDueDate", @required = "required", @id = "NextDueDt" }) 
    </div>
  </div>
</div> 

<div class="form-group"> 
  <label class="col-md-2 control-label">Advanced EMI  <span>   </span></label> 

<div class="col-md-3 selectContainer">
    <div class="input-group">
               @Html.CheckBox("isActive", false, new { @id = "bAdvancedEMI" })
    </div>
    <div  id="dvPrePaid" style="display:none"> 
        @Html.TextBoxFor(model => model.AdvancedEMI, new { @Value = "0", @placeholder = "Advanced EMI", @id = "AdvancedEMI" })
    </div>
</div>


</div> 
<!-- Success message -->
<label class="alert alert-success" style="display:none" role="alert" id="success_message"> <i class="glyphicon glyphicon-thumbs-up"></i> Success!.</label>
    
<!-- Button -->
<div class="form-group">
  <label class="col-md-4 control-label"></label>
  <div class="col-md-4 inputGroupContainer">
      <input type="button" style="float:left" id="btnSave" class="btn btn-warning" value="Submit"/>&nbsp&nbsp&nbsp
      <input type="submit" style="display:none;" id="btnSbmt" class="btn btn-warning" value="Submit"/>&nbsp&nbsp&nbsp
      <input type="button" value="Cancel" id="btnCancel" class="btn btn-warning" style="float:right" />
  </div>
</div>
</fieldset>
          }            
</div>
 
  <!-- /.container -->
  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.4.5/js/bootstrapvalidator.min.js'></script>
<script  src="js/index.js"></script>
</body>
</html>
<script type="text/javascript">

    $("#idDOD").click(function () {
        $("#idDOD").attr("type", "date");
    });

    $("#idDOD").mouseout(function () {
        if ($('#idDOD').val() == '') {
            $("#idDOD").attr("type", "text");
            $('#idDOD').val('@Model.Date_Of_Disbursement')
        }
    });

    $(document).ready(function () {

        if ('@Session["LoanLaterDisbusMbrID"]' != '') {
            $("#MbrID").val('@Session["LoanLaterDisbusMbrID"]');
        }

        if ('@Session["SavedMbrID"]' != '') {
            $("#MbrID").val('@Session["SavedMbrID"]');
        }


        $("#idDOD").change(function () {
            $("#lblmgs").html('');
            if ($('#idDOD').val().length == 0) {
                //$("#lblmgs").html("<h3 style='color: red;'>Please select From date and To date.</h3>");
                return;
            }
            else {
                var today = new Date();
                var frmDt = new Date($('#idDOD').val());
                if (frmDt.getDate() > today.getDate() && frmDt.getMonth() > today.getMonth() && frmDt.getFullYear() == today.getFullYear()) {
                    $("#lblmgs").html("<h3 style='color: red;'>Feture date is not allowed.</h3>");
                }
                else {
                    $('#DOD').val(frmDt.toLocaleDateString());
                    $("#lblmgs").html('');
                }
            }
        });

        $("#AdvancedEMI").change(function () {

            debugger;

            var PaidWeeks = $('#AdvancedEMI').val();

            var today = new Date();
            var DODDt = new Date($('#idDOD').val());

            if (PaidWeeks != '' && parseInt(PaidWeeks) > 0) {
                PaidWeeks = parseInt(PaidWeeks) + 1;
                var iDay = parseInt(PaidWeeks) * 7;

                var dat = new Date(DODDt);
                dat.setDate(dat.getDate() + iDay);


                $('#NextDueDt').val(dat.toLocaleDateString());

                //if (today.getDay() > 15) {
                //    var NxtDueDt = new Date(DODDt.getFullYear(), DODDt.getMonth()+1, iDay, 0, 0, 0, 0);
                //}
                //if (today.getDay() > 15 && today.getMonth() == 12) {
                //    var NxtDueDt = new Date(parseInt(DODDt.getFullYear()) + 1, 01, iDay, 0, 0, 0, 0);
                //}
                //else {
                //    var NxtDueDt = new Date(DODDt.getFullYear(), DODDt.getMonth(), iDay, 0, 0, 0, 0);
                //}
            }
        });




        if ('@Model.IsSucess' == "NewMbr") {

        }
        else if ('@Model.IsSucess' == "1") {
            $("#lblmgs").html("<h3 style='color: green'>Successfully Saved Loan Details For Member :" + '@Model.Savings' + ".</h3>");
            $('#myform')[0].reset();
        }
        else if ('@Model.IsSucess' == "2") {
            $("#lblmgs").html("<h3 style='color: red'>Failed To Save Loan Details try again.</h3>");
        }
        else if ('@Model.IsSucess' == "Exist") {
            $("#lblmgs").html("<h3 style='color: red'>This type of loan is already disbusred.</h3>");
        }
        else if ('@Model.IsSucess' == "L") {
            $("#lblmgs").html("<h3 style='color: red;'>Already This Member Have Active Loan.</h3>");
            alert("Member Already Have Active Loan");
        }
        @*else if ('@Model.IsSucess' == "Reneval") {
            var MbrId = prompt("Please enter member id", "");
            if (MbrId != null) {
                $.ajax({
                    url: '@Url.Action("ValidateMember", "Loans")',
                        type: "GET",
                        contentType: "application/json;charset=utf-8",
                        async: true,
                        data: { iMbrID: MbrId },
                        catch: false,
                        success: function (result) {
                            if (result != null || result != "") {                             
                                var vdata = result.split('/');
                                var oK = confirm("Group Code  = " + vdata[0] + '\r\n\r\n' +
                                                 "Member Name = " + vdata[1] + '\r\n\r\n' +
                                                 "Member Status = " + vdata[2] + '\r\n\r\n' +
                                                 "Member Address = " + vdata[3] + '\r\n\r\n' +
                                                 "Member Husbandname = "  + vdata[4]  + '\r\n\r\n' );
                                if (!oK) {
                                    window.location.href = '@Url.Action("HomePage", "Staff")';
                                }                              
                            }
                        },
                        error: function (errormessage) {
                            alert("Error While validating Member");
                        }
                    });
                    }
                }*@
    });

    $("#btnCancel").click(function () {
        $("form")[0].reset(); //.attr("action", "/home/cancelform");
    });

    $("#Loan_Amount").click(function () {
        if ($("#Loan_Amount").val() == "0.00") {
            $("#Loan_Amount").val('');
        } 
    });

    $("#Loan_Amount").mouseout(function () {
        if ($("#Loan_Amount").val() == "") {
            $("#Loan_Amount").val('0.00');
        }
    });

    $("#NoOfDays").click(function () {
        if ($("#NoOfDays").val() == "0") {
            $("#NoOfDays").val('');
        }
    });

    $("#NoOfDays").mouseout(function () {
        if ($("#NoOfDays").val() == "") {
            $("#NoOfDays").val('0');
        }
    });

     
      $("#GRFAmt").mouseout(function () {
          if ($("#GRFAmt").val() == "") {
              $("#GRFAmt").val('0.00');
          }
      });

    $("#GRFAmt").click(function () {
        if ($("#GRFAmt").val() == "0.00") {
            $("#GRFAmt").val('');
        }
    });

    $("#Insurance").click(function () {
        if ($("#Insurance").val() == "0.00") {
            $("#Insurance").val('');
        }
    });

    $("#Insurance").mouseout(function () {
        if ($("#Insurance").val() == "") {
            $("#Insurance").val('0.00');
        }
    });

    $("#Processing_Fee").click(function () {
        if ($("#Processing_Fee").val() == "0.00") {
            $("#Processing_Fee").val('');
        }
    });

    $("#Processing_Fee").mouseout(function () {
        if ($("#Processing_Fee").val() == "") {
            $("#Processing_Fee").val('0.00');
        }
    });

    $("#RateOfInterest").mouseout(function () {
        if ($("#RateOfInterest").val() == "") {
            $("#RateOfInterest").val('0.00');
        }
    });

    $("#RateOfInterest").click(function () {
        if ($("#RateOfInterest").val() == "0.00") {
            $("#RateOfInterest").val('');
        }
    });


    $("#Other_Income").click(function () {
        if ($("#Other_Income").val() == "0.00") {
            $("#Other_Income").val('');
        }
    });

    $("#Other_Income").mouseout(function () {
        if ($("#Other_Income").val() == "") {
            $("#Other_Income").val('0.00');
        }
    });


    $("#AdvancedEMI").click(function () {
        if ($("#AdvancedEMI").val() == "0") {
            $("#AdvancedEMI").val('');
        }
    });

    $("#AdvancedEMI").mouseout(function () {
        if ($("#AdvancedEMI").val() == "") {
            $("#AdvancedEMI").val('0');
        }
    });



    $("#btnSave").click(function () {
        debugger;
        var msg = "";
        if ($("#Loan_Amount").val() == "0.00") {
            msg = msg + "<br/> Please enter Loan Amount";
        }

        if ($("#NoOfDays").val() == "0") {
            msg = msg + "<br/> Please enter No Of Days";
        }

        if ($("#idDOD").val().length == 0) {
            msg = msg + "<br/> Please select Disbursement Date";
        }

        if ($("#Prin_EMI").val() == "0.00") {
            msg = msg + "<br/> Please check Prin EMI";
        }

        if ($("#RateOfInterest").val() == "0.00") {
            msg = msg + "<br/> Please enter Total Interest Amount";
        }

        if ($("#Expiry_Date").val().length == 0) {
            msg = msg + "<br/> Please enter End Date";
        }

        var drpGpID = $("#LoanType option:selected").val();
        if (drpGpID == "" || drpGpID == '-Select Loan Type-') {
            msg = msg + "<br/> Please Select Loan Type";
        }


        if (msg != "") {
            bootbox.alert(msg);
        }
        else {
            $("#btnSbmt").trigger("click");
        }
    });




    $("#idDOD").focusout(function () {
        debugger;
        var newDt = new Date($("#idDOD").val());

        var vDays = parseInt($("#NoOfDays").val() * 7)
        $("#Prin_EMI").val(Math.round(parseFloat($("#Loan_Amount").val() / parseInt($("#NoOfDays").val()))))

        newDt.setDate(newDt.getDate() + parseInt(vDays));

        $("#Expiry_Date").val(newDt.toLocaleDateString());

        var newDt2 = new Date($("#idDOD").val());
        newDt2.setDate(newDt2.getDate() + 7);
        $('#NextDueDt').val(newDt2.toLocaleDateString());


        //var IntRate = $("#Int_EMI").val(); 
        //var vIntRate = Math.round(parseFloat($("#Loan_Amount").val() * parseFloat($("#Int_EMI").val()) / 100));
        //$("#Int_EMI").val(IntRate + " (" + IntRate + ")")
        //$("#Int_EMI").val(Math.round(Math.round(parseFloat($("#Loan_Amount").val() * parseFloat($("#Int_EMI").val()) / 100)) / parseInt($("#NoOfDays").val())));

       @* if ('@Model.GType' == "Daily") {
            $("#Prin_EMI").val( Math.round(parseFloat($("#Loan_Amount").val() / parseInt($("#NoOfDays").val()))))
            $("#Int_EMI").val( Math.round(parseFloat($("#Loan_Amount").val() / parseFloat($("#Prin_EMI").val()))))
        }
        else if ('@Model.GType' == "Weekly") {

            var DlyEMI = parseFloat($("#Loan_Amount").val() / parseFloat($("#NoOfDays").val()));
            var WklyEMI = DlyEMI * 7;
            $("#Prin_EMI").val(Math.round(WklyEMI));
            $("#Int_EMI").val(Math.round(parseFloat($("#Loan_Amount").val()) / parseFloat(WklyEMI)))
        }

        var days =(parseFloat($("#NoOfDays").val() / 365));
        var TtlAmt =  Math.round(parseFloat($("#Loan_Amount").val()) * parseFloat(parseFloat($("#RateOfInterest").val()) / 100) * days);

        //$("#RateOfInterest").val(TtlAmt);*@

    });

    $("#bAdvancedEMI").click(function () {
        if ($("#bAdvancedEMI").is(':checked')) {
            $('#dvPrePaid').attr("style", "display:normal");
        }
        else {
            $('#dvPrePaid').attr("style", "display:none");
        }
    });




    $("#GrpCode").change(function () {

        loadData();
        var mbr = $("#drMbrId :selected").val();
        $("#MbrID").val(mbr);
    });

    $("#drMbrId").change(function () {
        var mbr = $("#drMbrId :selected").val();
        $("#MbrID").val(mbr);
    });

    //Load Data function
    function loadData() {
        var selectedGrpCode = $("#GrpCode :selected").val();

        $.ajax({
            url: '@Url.Action("GetLoanMemberList", "Loans")',
            type: "GET",
            contentType: "application/json;charset=utf-8",
            async: true,
            data: { sGrpCode: selectedGrpCode },
            catch: false,
            dataType: "json",
            success: function (res) {
                debugger;
                $("#drMbrId").empty();
                $.each(res, function (index, item) { // item is now an object containing properties ID and Text
                    $("#drMbrId").append($('<option></option>').text(item.Text).val(item.Value));
                });
                var mbr = $("#drMbrId :selected").val();
                $("#MbrID").val(mbr);
            },
            error: function (errormessage) {
                alert(errormessage.responseText);
            }
        });
    }

</script>

