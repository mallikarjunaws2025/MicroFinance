@model TestApp.VModels.Member.MemberViewModel
@{
    ViewBag.Title = "Create Member";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-primary fw-bold">
            <i class="fas fa-user-plus me-2"></i>Member Registration
        </h2>
        <a href="@Url.Action("MemberDetails_New", "Member")" class="btn btn-outline-secondary">
            <i class="fas fa-list me-2"></i>View All Members
        </a>
    </div>

    <!-- Registration Form Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-user me-2"></i>Member Information
            </h5>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("CreateMember", "Member", FormMethod.Post, new { @class = "needs-validation", @id = "memberRegistrationForm", @novalidate = "novalidate" }))
            {
                @Html.HiddenFor(model => model.IsSucess, new { @id = "IsSucess" })
                @Html.HiddenFor(model => model.MbrDOJ, new { @id = "MbrDOJ" })
                
                <div class="row g-4">
                    <!-- Group Selection -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Group Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-layer-group text-primary"></i>
                            </span>
                            @Html.DropDownListFor(x => Model.GrpCode, 
                                new SelectList(Model.GrpNameList, "Value", "Text"), 
                                "-- Select Group --", 
                                new { @class = "form-select", @required = "required", @id = "GrpCode" })
                        </div>
                        <div class="invalid-feedback">Please select a group.</div>
                    </div>

                    <!-- Member Name -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Member Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-user text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.MbrName, new { 
                                @class = "form-control", 
                                @placeholder = "Enter member full name", 
                                @required = "required", 
                                @id = "MbrName" 
                            })
                        </div>
                        <div class="invalid-feedback">Please enter member name.</div>
                    </div>

                    <!-- Husband Name -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Husband Name</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-male text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.HsbndName, new { 
                                @class = "form-control", 
                                @placeholder = "Enter husband name", 
                                @id = "HsbndName" 
                            })
                        </div>
                    </div>

                    <!-- Gender -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Gender <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-venus-mars text-primary"></i>
                            </span>
                            @Html.DropDownListFor(model => model.Gen, 
                                new List<SelectListItem> { 
                                    new SelectListItem { Value = "", Text = "-- Select Gender --" },
                                    new SelectListItem { Value = "Male", Text = "Male" }, 
                                    new SelectListItem { Value = "Female", Text = "Female" },
                                    new SelectListItem { Value = "Other", Text = "Other" }
                                }, 
                                new { @class = "form-select", @required = "required", @id = "Gen" })
                        </div>
                        <div class="invalid-feedback">Please select gender.</div>
                    </div>

                    <!-- Age -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Age <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-birthday-cake text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.Age, new { 
                                @class = "form-control", 
                                @type = "number",
                                @min = "18",
                                @max = "100",
                                @placeholder = "Enter age", 
                                @required = "required", 
                                @id = "Age" 
                            })
                        </div>
                        <div class="invalid-feedback">Please enter a valid age (18-100).</div>
                    </div>

                    <!-- Date of Join -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Date of Join</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-calendar text-primary"></i>
                            </span>
                            <input class="form-control" type="date" id="MbrDOJ" name="MbrDOJ" />
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-toggle-on text-primary"></i>
                            </span>
                            @Html.DropDownListFor(model => model.MbrStatus, 
                                new List<SelectListItem> { 
                                    new SelectListItem { Value = "", Text = "-- Select Status --" },
                                    new SelectListItem { Value = "Active", Text = "Active", Selected = true }, 
                                    new SelectListItem { Value = "Cancel", Text = "Cancel" } 
                                }, 
                                new { @class = "form-select", @required = "required", @id = "MbrStatus" })
                        </div>
                        <div class="invalid-feedback">Please select member status.</div>
                    </div>

                    <!-- Staff Name -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Staff Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-user-tie text-primary"></i>
                            </span>
                            @Html.DropDownListFor(x => Model.StaffID, 
                                new SelectList(Model.StaffMbrList, "Value", "Text"), 
                                "-- Select Staff --", 
                                new { @class = "form-select", @required = "required", @id = "StaffID" })
                        </div>
                        <div class="invalid-feedback">Please select a staff member.</div>
                    </div>

                    <!-- Contact Number -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Contact Number</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-phone text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.CantactNum, new { 
                                @class = "form-control", 
                                @type = "tel",
                                @pattern = "[0-9]{10}",
                                @placeholder = "Enter 10-digit contact number", 
                                @id = "CantactNum" 
                            })
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="col-12">
                        <label class="form-label fw-semibold">Address <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                            </span>
                            @Html.TextAreaFor(model => model.MbrAddress, new { 
                                @class = "form-control", 
                                @placeholder = "Enter complete address", 
                                @required = "required", 
                                @id = "MbrAddress",
                                @rows = "3"
                            })
                        </div>
                        <div class="invalid-feedback">Please enter member address.</div>
                    </div>

                    <!-- Adhaar Card Number -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Adhaar Card Number <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-id-card text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.AdharaCardNum, new { 
                                @class = "form-control", 
                                @type = "text",
                                @pattern = "[0-9]{12}",
                                @placeholder = "Enter 12-digit Adhaar number", 
                                @required = "required", 
                                @id = "AdharaCardNum",
                                @maxlength = "12"
                            })
                        </div>
                        <div class="invalid-feedback">Please enter a valid 12-digit Adhaar number.</div>
                    </div>

                    <!-- Ration Card Number -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Ration Card Number</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-credit-card text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.RationCardNum, new { 
                                @class = "form-control", 
                                @placeholder = "Enter ration card number", 
                                @id = "RationCardNum" 
                            })
                        </div>
                    </div>

                    <!-- Nominee -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Nominee Name</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-user-shield text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.Nominee, new { 
                                @class = "form-control", 
                                @placeholder = "Enter nominee name", 
                                @id = "Nominee" 
                            })
                        </div>
                        <div class="form-text">Person who will receive benefits if needed</div>
                    </div>

                    <!-- Contact Number 2 -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Contact Number 2</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-phone text-primary"></i>
                            </span>
                            @Html.TextBoxFor(model => model.PhoneNo2, new { 
                                @class = "form-control", 
                                @type = "tel",
                                @pattern = "[0-9]{10}",
                                @placeholder = "Enter alternate contact number", 
                                @id = "PhoneNo2" 
                            })
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="col-12">
                        <hr class="my-4">
                        <div class="d-flex justify-content-end gap-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>Reset Form
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Register Member
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="mt-3"></div>
</div>

<script>
$(document).ready(function() {
    // Initialize form validation
    initializeFormValidation();
    
    // Auto-calculate age from DOB (note: using MbrDOJ as date field)
    $('#MbrDOJ').on('change', function() {
        calculateAge();
    });
    
    // Phone number formatting for both contact fields
    $('#CantactNum, #PhoneNo2').on('input', function() {
        formatPhoneNumber(this);
    });
    
    // Adhaar Card validation
    $('#AdharaCardNum').on('input', function() {
        formatAdhaarCard(this);
    });
    
    // Form submission handling
    $('#memberRegistrationForm').on('submit', function(e) {
        e.preventDefault();
        if (this.checkValidity()) {
            submitForm();
        } else {
            e.stopPropagation();
            this.classList.add('was-validated');
        }
    });
});

function initializeFormValidation() {
    // Real-time validation
    $('.form-control, .form-select').on('input change', function() {
        if (this.checkValidity()) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    });
    
    // Custom validation for member name
    $('#MbrName').on('input', function() {
        const value = this.value.trim();
        if (value.length < 2) {
            this.setCustomValidity('Member name must be at least 2 characters long');
        } else if (value.length > 50) {
            this.setCustomValidity('Member name must not exceed 50 characters');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Age validation
    $('#Age').on('input', function() {
        const age = parseInt(this.value);
        if (age < 18) {
            this.setCustomValidity('Member must be at least 18 years old');
        } else if (age > 100) {
            this.setCustomValidity('Please enter a valid age');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Adhaar Card validation
    $('#AdharaCardNum').on('input', function() {
        const value = this.value.replace(/\s/g, '');
        if (value.length > 0 && value.length !== 12) {
            this.setCustomValidity('Adhaar Card must be exactly 12 digits');
        } else if (value.length === 12 && !/^\d{12}$/.test(value)) {
            this.setCustomValidity('Adhaar Card must contain only numbers');
        } else {
            this.setCustomValidity('');
        }
    });
}

function calculateAge() {
    const doj = new Date($('#MbrDOJ').val());
    const today = new Date();
    if (doj && doj < today) {
        // Calculate age based on join date (this might need adjustment based on business logic)
        const age = Math.floor((today - doj) / (365.25 * 24 * 60 * 60 * 1000));
        if (age > 0 && age <= 100) {
            $('#Age').val(age);
            $('#Age').trigger('input');
        }
    }
}

function formatPhoneNumber(input) {
    // Remove non-numeric characters
    let value = input.value.replace(/\D/g, '');
    
    // Limit to 10 digits
    if (value.length > 10) {
        value = value.slice(0, 10);
    }
    
    input.value = value;
    
    // Validation
    if (value.length === 10) {
        input.setCustomValidity('');
    } else if (value.length > 0) {
        input.setCustomValidity('Please enter a valid 10-digit phone number');
    }
}

function formatAdhaarCard(input) {
    // Remove non-numeric characters
    let value = input.value.replace(/\D/g, '');
    
    // Limit to 12 digits
    if (value.length > 12) {
        value = value.slice(0, 12);
    }
    
    // Format with spaces for readability (XXXX XXXX XXXX)
    if (value.length > 4 && value.length <= 8) {
        value = value.slice(0, 4) + ' ' + value.slice(4);
    } else if (value.length > 8) {
        value = value.slice(0, 4) + ' ' + value.slice(4, 8) + ' ' + value.slice(8);
    }
    
    input.value = value;
}

function submitForm() {
    const button = $('#submitBtn');
    const originalText = button.html();
    
    // Show loading state
    button.html('<span class="spinner-border spinner-border-sm me-2"></span>Registering...');
    button.prop('disabled', true);
    
    // Set the date of joining for hidden field
    $('#MbrDOJ').val($('#MbrDOJ').val());
    
    // Get form data
    const formData = new FormData(document.getElementById('memberRegistrationForm'));
    
    $.ajax({
        url: '@Url.Action("CreateMember_New", "Member")',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(result) {
            if (result.success || result === "Success") {
                showMessage('Member registered successfully!', 'success');
                
                // Redirect to member list after 2 seconds
                setTimeout(function() {
                    window.location.href = '@Url.Action("MemberDetails_New", "Member")';
                }, 2000);
            } else {
                showMessage(result.message || 'Error registering member. Please try again.', 'error');
                button.html(originalText);
                button.prop('disabled', false);
            }
        },
        error: function(xhr, status, error) {
            showMessage('An error occurred while registering the member. Please try again.', 'error');
            console.error('Error:', error);
            button.html(originalText);
            button.prop('disabled', false);
        }
    });
}

function resetForm() {
    document.getElementById('memberRegistrationForm').reset();
    $('.form-control, .form-select').removeClass('is-valid is-invalid');
    $('#memberRegistrationForm').removeClass('was-validated');
    $('#messageContainer').empty();
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    
    const alert = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="${icon} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#messageContainer').html(alert);
    
    // Auto-dismiss after 5 seconds for success messages
    if (type === 'success') {
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 5000);
    }
    
    // Scroll to message
    $('html, body').animate({
        scrollTop: $('#messageContainer').offset().top - 100
    }, 500);
}
</script>