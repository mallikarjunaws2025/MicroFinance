@model TestApp.VModels.Member.MemberViewModel
@{
    ViewBag.Title = "Loans Report";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}

<style>
    .report-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-label {
        font-weight: 600;
        color: #495057;
        min-width: 120px;
    }
    
    .custom-select {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
        background: white;
    }
    
    .custom-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .staff-section {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .report-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 1rem 0.8rem;
        text-align: center;
        font-size: 0.9rem;
        border: none;
    }
    
    .report-table tbody td {
        padding: 0.8rem;
        border: 1px solid #e9ecef;
        vertical-align: middle;
        text-align: center;
    }
    
    .report-table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }
    
    .report-table tbody tr:hover {
        background: #e3f2fd;
        transition: background-color 0.2s ease;
    }
    
    .staff-cell {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        color: white !important;
        font-weight: 700;
        font-size: 1rem;
        text-align: center;
        vertical-align: middle;
    }
    
    .group-cell {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        color: white !important;
        font-weight: 600;
        font-size: 0.95rem;
        text-align: center;
        vertical-align: middle;
    }
    
    .member-name {
        font-weight: 600;
        color: #495057;
    }
    
    .loan-amount {
        color: #dc3545;
        font-weight: 600;
    }
    
    .total-row {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        color: white !important;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .total-row td {
        border: none !important;
    }
    
    .signature-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        margin-top: 2rem;
        border: 2px dashed #dee2e6;
    }
    
    .signature-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed #adb5bd;
    }
    
    .signature-item {
        text-align: center;
        min-width: 200px;
    }
    
    .no-data {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        font-style: italic;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 2rem 0;
    }
    
    @@media print {
        .filter-section, .btn-modern { display: none !important; }
        .report-container { box-shadow: none; }
        .signature-section { display: block !important; }
        #pReportInfo { display: block !important; }
        body { margin: 0; }
        .report-table { page-break-inside: avoid; }
    }
</style>

<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PrintArea/2.4.1/jquery.PrintArea.js" type="text/javascript"></script>

<div class="container-fluid">
    <div class="report-header">
        <h2><i class="fa fa-chart-line"></i> Loans Report</h2>
        <p class="mb-0">Staff-wise Group and Member Loan Details</p>
    </div>

    @using (Html.BeginForm("", "", FormMethod.Post))
    {
        <div class="filter-section">
            <h5><i class="fa fa-filter"></i> Report Filters</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="filter-group">
                        <label class="filter-label">Staff Name:</label>
                        @Html.DropDownListFor(x => Model.StaffMbrList, new SelectList(Model.StaffMbrList, "Text", "Text"), "--All Staff--", htmlAttributes: new { @class = "custom-select", @id = "StaffId" })
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="filter-group">
                        <label class="filter-label">Group Name:</label>
                        @Html.DropDownListFor(x => Model.GrpNameList, new SelectList(Model.GrpNameList, "Value", "Text"), "--All Groups--", htmlAttributes: new { @class = "custom-select", @id = "GrpCode" })
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="filter-group">
                        <button type="button" id="btnPrint" class="btn-modern">
                            <i class="fa fa-print"></i> Print Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dvReportData" class="report-container">
            <div id="pReportInfo" style="display:none">
                <p><strong>Staff Name:</strong> <span id="lblStaff"></span></p>
                <p><strong>Group Name:</strong> <span id="lblGrpCode"></span></p>
                <p><strong>Report Date:</strong> @DateTime.Today.Day/@DateTime.Today.Month/@DateTime.Today.Year</p>
                <hr />
            </div>
            
            <table class="report-table" id="loansTable">
                <thead>
                    <tr>
                        <th>Staff Name</th>
                        <th>Group Name</th>
                        <th>Member Name</th>
                        <th>Loan ID</th>
                        <th>Loan Amount</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>

        <div class="signature-section" id="signatureSection" style="display:none">
            <div class="signature-row">
                <div class="signature-item">
                    <strong>CO Signature</strong><br />
                    <div style="border-bottom: 2px solid #333; margin-top: 2rem; width: 200px;"></div>
                </div>
                <div class="signature-item">
                    <strong>BM Signature</strong><br />
                    <div style="border-bottom: 2px solid #333; margin-top: 2rem; width: 200px;"></div>
                </div>
            </div>
            <div class="signature-row" style="border-bottom: none;">
                <div class="signature-item">
                    <strong>Visitor Signature</strong><br />
                    <div style="border-bottom: 2px solid #333; margin-top: 2rem; width: 200px;"></div>
                </div>
                <div></div>
            </div>
        </div>
    }
</div>

<script type="text/javascript">
    // Load Data when document is ready
    $(document).ready(function () {
        loadReportData();
        
        // Print button functionality - bind after DOM is ready
        $("#btnPrint").click(function () {
            updateLabels();
            $('#pReportInfo').show();
            $('#signatureSection').show();
            
            // Use native browser print dialog
            window.print();
            
            // Hide elements back after print dialog closes
            setTimeout(function() {
                $('#pReportInfo').hide();
                $('#signatureSection').hide();
            }, 500);
        });
    });

    // Event handlers for filter changes
    $("#GrpCode").change(function () {
        updateLabels();
        loadReportData();
    });

    $("#StaffId").change(function () {
        updateLabels();
        loadReportData();
    });

    function updateLabels() {
        $("#lblStaff").text($("#StaffId :selected").text());
        $("#lblGrpCode").text($("#GrpCode :selected").text());
    }

    // Main data loading function
    function loadReportData() {
        var vGrpName = $("#GrpCode :selected").val();
        var vStaffName = $("#StaffId :selected").val();

        $.ajax({
            url: '@Url.Action("GetLoansReportData","Report")',
            type: "GET",
            contentType: "application/json;charset=utf-8",
            data: { sGrpName: vGrpName, sStaffName: vStaffName },
            dataType: "json",
            success: function (result) {
                if (result && result.length > 0) {
                    renderHierarchicalReport(result);
                } else {
                    renderNoData();
                }
            },
            error: function (errormessage) {
                console.error("Error loading report data:", errormessage);
                renderError();
            }
        });
    }

    function renderHierarchicalReport(data) {
        var html = '';
        var staffGroups = {};
        var totalAmount = 0;

        // Group data by Staff and then by Group
        data.forEach(function(item) {
            if (item.MbrStatus === "End") {
                totalAmount = parseFloat(item.Balance_Amount) || 0;
                return;
            }

            if (!staffGroups[item.StaffName]) {
                staffGroups[item.StaffName] = {};
            }
            
            if (!staffGroups[item.StaffName][item.GrpName]) {
                staffGroups[item.StaffName][item.GrpName] = [];
            }
            
            staffGroups[item.StaffName][item.GrpName].push(item);
        });

        // Render hierarchical table structure
        for (var staffName in staffGroups) {
            var staffMemberCount = 0;
            
            // Count total members for this staff
            for (var groupName in staffGroups[staffName]) {
                staffMemberCount += staffGroups[staffName][groupName].length;
            }
            
            var staffRowRendered = false;
            
            for (var groupName in staffGroups[staffName]) {
                var members = staffGroups[staffName][groupName];
                var groupRowRendered = false;
                
                members.forEach(function(member, memberIndex) {
                    html += '<tr>';
                    
                    // Staff name cell (rowspan for all members under this staff)
                    if (!staffRowRendered) {
                        html += '<td class="staff-cell" rowspan="' + staffMemberCount + '">' + staffName + '</td>';
                        staffRowRendered = true;
                    }
                    
                    // Group name cell (rowspan for all members in this group)
                    if (!groupRowRendered) {
                        html += '<td class="group-cell" rowspan="' + members.length + '">' + groupName + '</td>';
                        groupRowRendered = true;
                    }
                    
                    // Member details
                    html += '<td class="member-name">' + (member.MbrName || 'N/A') + '</td>';
                    html += '<td>' + (member.LoanID || 'N/A') + '</td>';
                    html += '<td class="loan-amount">Rs. ' + (member.Loan_Amount || '0') + '</td>';
                    html += '<td>' + (member.CantactNo || 'N/A') + '</td>';
                    html += '</tr>';
                });
            }
        }

        // Add total row
        if (totalAmount > 0) {
            html += '<tr class="total-row">';
            html += '<td colspan="4" style="text-align: center; font-weight: 700;">Total Loan Amount</td>';
            html += '<td style="font-weight: 700;">Rs. ' + totalAmount.toLocaleString() + '</td>';
            html += '<td></td>';
            html += '</tr>';
        }

        $('#reportTableBody').html(html);
    }

    function renderNoData() {
        var html = '<tr>';
        html += '<td colspan="6" class="no-data">';
        html += '<i class="fa fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #6c757d;"></i><br>';
        html += '<strong>No Data Available</strong><br>';
        html += 'No loan records found for the selected criteria.';
        html += '</td>';
        html += '</tr>';
        
        $('#reportTableBody').html(html);
    }

    function renderError() {
        var html = '<tr>';
        html += '<td colspan="6" class="no-data" style="color: #dc3545;">';
        html += '<i class="fa fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>';
        html += '<strong>Error Loading Data</strong><br>';
        html += 'There was an error loading the report data. Please try again.';
        html += '</td>';
        html += '</tr>';
        
        $('#reportTableBody').html(html);
    }
</script>


