@model IEnumerable<TestApp.DB.FinGroup>
@{
    ViewBag.Title = "Group Management";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-primary fw-bold">
            <i class="fas fa-layer-group me-2"></i>Group Management
        </h2>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="exportGroupList()">
                <i class="fas fa-download me-2"></i>Export
            </button>
            @if (ViewBag.IsAdmin == true)
            {
                <a href="@Url.Action("CreateGroup", "Group")" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add New Group
                </a>
            }
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Total Groups</h6>
                            <h4 class="mb-0">@Model.Count()</h4>
                        </div>
                        <i class="fas fa-layer-group fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Active Groups</h6>
                            <h4 class="mb-0">@Model.Count(g => g.GStatus == "Active")</h4>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Inactive Groups</h6>
                            <h4 class="mb-0">@Model.Count(g => g.GStatus == "Inactive")</h4>
                        </div>
                        <i class="fas fa-pause-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Total Members</h6>
                            <h4 class="mb-0">@ViewBag.TotalMembers</h4>
                        </div>
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="fas fa-search me-2"></i>Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Search Groups</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by name, code, or location...">
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Filter by Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy">
                        <option value="name">Group Name</option>
                        <option value="date">Created Date</option>
                        <option value="members">Member Count</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Groups Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Groups List
                <span class="badge bg-primary ms-2" id="recordCount">@Model.Count() records</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 align-middle" id="groupsTable">
                    <thead class="table-dark">
                        <tr class="text-nowrap">
                            <th class="px-3"><i class="fas fa-hashtag me-1"></i>Code</th>
                            <th class="px-3"><i class="fas fa-layer-group me-1"></i>Group Name</th>
                            <th class="px-3"><i class="fas fa-map-marker-alt me-1"></i>Location</th>
                            <th class="px-3"><i class="fas fa-calendar me-1"></i>Created Date</th>
                            <th class="px-3"><i class="fas fa-users me-1"></i>Members</th>
                            <th class="px-3"><i class="fas fa-info-circle me-1"></i>Status</th>
                            <th class="px-3 text-center" style="min-width: 180px;"><i class="fas fa-cogs me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var group in Model)
                            {
                                <tr data-group-id="@group.GroupID">
                                    <td>
                                        <span class="badge bg-primary">@group.GroupCode</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center me-3">
                                                <i class="fas fa-layer-group text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@group.GrpName</div>
                                                <small class="text-muted">ID: @group.GroupID</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            @(group.Village ?? "Not specified")
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-muted">
                                            @(group.DOC ?? "N/A")
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            @(group.Net_Members ?? 0) members
                                        </span>
                                    </td>
                                    <td>
                                        @{
                                            var statusClass = group.GStatus == "Active" ? "bg-success" : 
                                                            group.GStatus == "Inactive" ? "bg-danger" : "bg-warning";
                                        }
                                        <span class="badge @statusClass">
                                            @(group.GStatus ?? "Unknown")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Group actions">
                                            <button type="button" class="btn btn-outline-info" 
                                                    onclick="viewGroupDetails(@group.GroupID)" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            @if (ViewBag.IsAdmin == true)
                                            {
                                                <button type="button" class="btn btn-outline-primary" 
                                                        onclick="editGroup(@group.GroupID)" title="Edit Group">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="showDeleteConfirm(@group.GroupID, '@group.GrpName')" title="Delete Group">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                            <button type="button" class="btn btn-outline-success" 
                                                    onclick="manageMembers(@group.GroupID)" title="Manage Members">
                                                <i class="fas fa-users"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-layer-group fa-3x mb-3 opacity-50"></i>
                                        <h5>No Groups Found</h5>
                                        <p>Start by creating your first group.</p>
                                        @if (ViewBag.IsAdmin == true)
                                        {
                                            <a href="@Url.Action("CreateGroup_New", "Group")" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Create Group
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Group Details Modal -->
<div class="modal fade" id="groupDetailsModal" tabindex="-1" aria-labelledby="groupDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupDetailsModalLabel">
                    <i class="fas fa-layer-group me-2"></i>Group Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="groupDetailsContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the group "<span id="groupNameToDelete"></span>"?</p>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action cannot be undone and will affect all associated members and loans.
                </div>
                <input type="hidden" id="groupIdToDelete" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete Group
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    initializeTableFeatures();
    updateRecordCount();
    
    // Search functionality
    $('#searchInput').on('keyup', function() {
        filterTable();
    });
    
    // Filter functionality
    $('#statusFilter, #sortBy').on('change', function() {
        filterTable();
    });
    
    // Delete confirmation
    $('#confirmDeleteBtn').on('click', function() {
        deleteGroup();
    });
});

function initializeTableFeatures() {
    // Add sorting functionality
    $('.table thead th').each(function(index) {
        if ($(this).text().trim() && index < 6) { // Exclude actions column
            $(this).addClass('sortable');
            $(this).css('cursor', 'pointer');
            $(this).append(' <i class="fas fa-sort text-muted ms-1"></i>');
            
            $(this).on('click', function() {
                sortTable(index);
            });
        }
    });
}

function filterTable() {
    const searchTerm = $('#searchInput').val().toLowerCase();
    const statusFilter = $('#statusFilter').val();
    let visibleCount = 0;
    
    $('#groupsTable tbody tr').each(function() {
        const row = $(this);
        if (row.find('td').length === 1) return; // Skip "no data" row
        
        const groupName = row.find('td:eq(1)').text().toLowerCase();
        const groupCode = row.find('td:eq(0)').text().toLowerCase();
        const location = row.find('td:eq(2)').text().toLowerCase();
        const status = row.find('td:eq(5) .badge').text().trim();
        
        const matchesSearch = !searchTerm || 
            groupName.includes(searchTerm) || 
            groupCode.includes(searchTerm) || 
            location.includes(searchTerm);
        
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
            row.show();
            visibleCount++;
        } else {
            row.hide();
        }
    });
    
    updateRecordCount(visibleCount);
}

function sortTable(columnIndex) {
    const table = $('#groupsTable');
    const rows = table.find('tbody tr').toArray();
    
    rows.sort(function(a, b) {
        const aText = $(a).find('td').eq(columnIndex).text().trim();
        const bText = $(b).find('td').eq(columnIndex).text().trim();
        
        if (columnIndex === 3) { // Date column
            return new Date(aText) - new Date(bText);
        } else if (columnIndex === 4) { // Members column
            return parseInt(aText) - parseInt(bText);
        } else {
            return aText.localeCompare(bText);
        }
    });
    
    table.find('tbody').empty().append(rows);
    
    // Update sort icons
    table.find('thead th .fas').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
    table.find('thead th').eq(columnIndex).find('.fas')
        .removeClass('fa-sort').addClass('fa-sort-up');
}

function clearFilters() {
    $('#searchInput').val('');
    $('#statusFilter').val('');
    $('#sortBy').val('name');
    filterTable();
}

function updateRecordCount(count) {
    const total = @Model.Count();
    const displayCount = count !== undefined ? count : total;
    const text = displayCount === total ? `${total} records` : `${displayCount} of ${total} records`;
    $('#recordCount').text(text);
}

function viewGroupDetails(groupId) {
    // Show loading state
    $('#groupDetailsContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading group details...</div>
        </div>
    `);
    
    $('#groupDetailsModal').modal('show');
    
    // Load group details via AJAX
    $.ajax({
        url: '@Url.Action("GetGroupDetails", "Group")',
        type: 'GET',
        data: { id: groupId },
        success: function(data) {
            $('#groupDetailsContent').html(data);
        },
        error: function() {
            $('#groupDetailsContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading group details. Please try again.
                </div>
            `);
        }
    });
}

function editGroup(groupId) {
    window.location.href = '@Url.Action("EditGroup", "Group")' + '?id=' + groupId;
}

function showDeleteConfirm(groupId, groupName) {
    $('#groupIdToDelete').val(groupId);
    $('#groupNameToDelete').text(groupName);
    $('#deleteConfirmModal').modal('show');
}

function deleteGroup() {
    const groupId = $('#groupIdToDelete').val();
    const button = $('#confirmDeleteBtn');
    const originalText = button.html();
    
    button.html('<span class="spinner-border spinner-border-sm me-2"></span>Deleting...');
    button.prop('disabled', true);
    
    $.ajax({
        url: '@Url.Action("DeleteGroup", "Group")',
        type: 'POST',
        data: { id: groupId },
        success: function(result) {
            if (result.success) {
                $('#deleteConfirmModal').modal('hide');
                $(`tr[data-group-id="${groupId}"]`).fadeOut(500, function() {
                    $(this).remove();
                    updateRecordCount();
                });
                showToast('Group deleted successfully', 'success');
            } else {
                showToast(result.message || 'Error deleting group', 'error');
            }
        },
        error: function() {
            showToast('Error deleting group', 'error');
        },
        complete: function() {
            button.html(originalText);
            button.prop('disabled', false);
        }
    });
}

function manageMembers(groupId) {
    window.location.href = '@Url.Action("MemberDetails", "Member")' + '?groupId=' + groupId;
}

function exportGroupList() {
    exportTableToCSV('groupsTable', 'groups-list.csv');
}

// Show toast notification
function showToast(message, type) {
    type = type || 'info';
    const bgClass = 'bg-' + (type === 'error' ? 'danger' : type);
    
    const toast = $(`
        <div class="toast align-items-center text-white ${bgClass} border-0 position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999;" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('body').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        toast.remove();
    });
}
</script>
}

<style>
.avatar-sm {
    width: 40px;
    height: 40px;
}

.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.table tbody tr:hover {
    transform: translateX(2px);
    transition: transform 0.2s ease;
}

.btn-group .btn {
    margin: 0 1px;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
</style>