@model  TestApp.VModels.Loans.LoanCols
@{
    ViewBag.Title = "MemberDetails";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
}
<html>
<head>
    <title>
        <h3>Loan Recovery</h3>
    </title>
    <script src="~/Scripts/jquery-1.11.1.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <link href="~/Scripts/Stylesheet.css" rel="stylesheet" />

        <script src="https://code.jquery.com/jquery-3.3.1.js"></script> 

    @*<meta charset="UTF-8">*@
     <script src="https://cdnjs.cloudflare.com/ajax/libs/PrintArea/2.4.1/jquery.PrintArea.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css'>
    <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css'>
    <link rel='stylesheet prefetch' href='http://cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/css/bootstrapValidator.min.css'>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .drpdwn {
            width: 43px;
            height: 30px;
        }

        .LPost {
        }

        .LPre {
        }
    </style>
</head>
<body>
    @using (Html.BeginForm("LoansCols", "Loans", FormMethod.Post))
    {        
        @Html.HiddenFor(model => model.PrepaidLoanIds, new { @id = "PrepaidLoanIds" }) 
         
        <div class="container">
            
            <h3>Loan Recovery</h3>
            <div style="float: left; margin-top: 1%;">
                <label>Select Group Code&nbsp</label>@Html.DropDownListFor(x => Model.GrpCodeList, new SelectList(Model.GrpCodeList, "Value", "Text"), "--All Groups--", htmlAttributes: new { @class = "btn btn-primary", @style = "width: 150px;", @id = "GrpCode" })&nbsp
            <label>Select Staff Name&nbsp</label>@Html.DropDownListFor(x => Model.StaffMbrList, new SelectList(Model.StaffMbrList, "Text", "Text"), "--All Staff--", htmlAttributes: new { @class = "btn btn-primary", @style = "width: 150px;", @id = "StaffId" })&nbsp&nbsp
                 <label>Enter Member ID/Name &nbsp</label>@Html.TextBoxFor(x => Model.SrchQry, htmlAttributes: new { @class = "btn btn-primary", @style = "width: 150px;", @id = "MbrIDName" })
                <input type="button" value="Print" id="btnPrint" class="btn btn-primary" />
            </div>
            <br />
            <br />
           @* <div class="form-control" style="height: 400px; overflow: auto;">*@
                <div  id="dvDailyreportData" style="height:400px;border:none"><br /><p id="pStaffName" style="display:none">Staff Name : <label id="lblStaff"></label><br /> Report Date :  @DateTime.Today.ToString("dd/MM/yyyy")</p>
                <table id="LoanColstbl" class="table table-bordered table-hover">
                    <thead>
                        <tr style="background-color: #428bca; color: #1b0a0a;">
                            <th style="display: none">Loan ID.
                            </th>
                            <th style="display: none">Member Id
                            </th>
                            <th>Member Name.
                            </th>
                            <th>Group Name.
                            </th>
                            <th>Loan Amt(+ Interest)
                            </th>
                            <th>Tentur
                            </th>
                            <th>Paid Installments
                            </th>
                            <th>Paid Amount
                            </th>
                            <th>Balance Amount
                            </th>
                            <th>Balance Installments
                            </th>
                            <th>Current Due
                            </th>
                           @* <th>ALR Net Savings
                            </th>
                            <th>After Adjustment  
                            </th>
                            <th>During ALR Savings  
                            </th>*@
                            <th>Post 
                            </th>
                            <th>Pre-Paid 
                            </th>
                            <th>Action 
                            </th>
                        </tr>
                    </thead>
                    <tbody  class="tbody">
                    </tbody>
                </table>
                     </div>
                <div class="form-group" style="float: right;">
                    <input type="button" style="background: #428bca" id="btnSelectAll" class="btn btn-warning" value="Select All Postings" />

                    &nbsp&nbsp  
                    <input type="button" style="background: #428bca" id="btnSelectAllPre" class="btn btn-warning" value="Select All Pre-Paids" />
                    &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp  
                    <input type="button" style="float: right; background: #428bca" onclick="LoanPosting()" id="btnPostAll" class="btn btn-warning" value="Post All" />

                   @* &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp  
                    <input type="button" style="float: right; background: #428bca" id="btnAdvancedALRmbrsList" class="btn btn-warning" value="Post All" />*@

                @*</div>*@
                <label id="lblTodayDue"></label>
            </div>
            <br />
        </div> 

    }
    <!-- /.container -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.4.5/js/bootstrapvalidator.min.js'></script>
    <script src="js/index.js"></script>

</body>
</html>

<script type="text/javascript">
    //Load Data in Table when documents is read
    
    $(document).ready(function () {
        loadData();        
    });

    $("#GrpCode").change(function () {
 $("#lblStaff").html($("#GrpCode :selected").text());
       
        loadData();

        $("#lblStaff").html($("#StaffId :selected").text());
    });
    $("#StaffId").change(function () {
        loadData();

        $("#lblStaff").html($("#StaffId :selected").text());
	 
    });

    $("#MbrIDName").keyup(function () {
        loadData();
    });



    //Load Data function
    function loadData() {
        var selectedGrpCode = $("#GrpCode :selected").text();
        var vStaffId = $("#StaffId").val();
        var vMbrId = $("#MbrIDName").val();
        $.ajax({
            url: '@Url.Action("LoansList", "Loans")',
            type: "GET",
            contentType: "application/json;charset=utf-8",
            async: true,
            data: { sGrpName: selectedGrpCode, sStaffName: vStaffId, sMbrID: vMbrId },
            catch: false,
            dataType: "json",
            success: function (result) {

                var html = '';
                var vCurrentDue = '';
                $.each(result, function (key, item) {
                    html += '<tr id="rw' + item.LoanID + '">';
                    html += '<td style="display:none" id="tdID' + item.LoanID + '">' + item.LoanID + '</td>';
                    html += '<td style="display:none">' + item.MbrId + '</td>';
                    html += '<td>' + item.MbrName + '</td>';
                    html += '<td>' + item.GrpName + '</td>';
                    html += '<td id="tdLA' + item.LoanID + '"> ' + item.Actual_Balance + '</td>';
                    html += '<td>' + item.NoOfDay + '</td>';
                    html += '<td id="tdPE' + item.LoanID + '">' + item.PaidEMI + '</td>';
                    html += '<td id="tdCA' + item.LoanID + '">' + parseFloat(parseFloat(item.Collected_Amount) * parseInt(item.PaidEMI)) + '</td>';
                    html += '<td id="tdBL' + item.LoanID + '">' + item.Balance_Amount + '</td>';
                    html += '<td>' + item.Balance_Installment + '</td>';
                    html += '<td id="tdCD' + item.LoanID + '">' + item.Prin_EMI + '</td>';
                    //html += '<td id="tdNtSvg' + item.LoanID + '">' + item.NetSavings + '</td>';
                    //html += '<td><input type="text" id="txtAdjst' + item.LoanID + '" disabled="disabled" style="width: 40px;" value="0.00"/></td>';
                    //html += '<td><input type="text" id="txt' + item.LoanID + '" style="width: 40px;" value="0.00"/></td>';

                    html += '<td><input type="checkbox" checked=true class="LPost" value="Post,' + item.LoanID + '"/></td>';

                    html += '<td><input type="checkbox"  id="ck' + item.LoanID + '" class="LPre" onchange="SwapValForPrePaid(ck' + item.LoanID + ')" value="PrePaid,' + item.LoanID + '"/></td>';

                    html += '<td><a href="#" onclick="return getbyID(' + item.LoanID + ')">Post</a></td>';

                    html += '</tr>';
                });
                $('.tbody').html(html);

            },
            error: function (errormessage) {
                alert(errormessage.responseText);
            }
        });
    }


    //Function for getting the Data Based upon Employee ID
    function getbyID(InputData) {

        $.ajax({
            url: '@Url.Action("GetLoanIDFromView", "Loans")',
            type: "GET",
            contentType: "application/json",
            data: { sLoanID: InputData },
            catch: false,
            success: function (result) {
                if (result == 'True') {
                    $("#btnPostAll").click();
                }
            },
            error: function (errormessage) {
                alert("Error while process your request");
            }
        });
    }

    @*$(function () {
        $("#btnAdvancedALRmbrsList").click(function () {
            var selectedGrpCode = $("#GrpCode :selected").text();
            var vStaffId = $("#StaffId").val();

            $.ajax({
                url: '@Url.Action("GetTodayALRMbrList", "Loans")',
                type: "GET",
                contentType: "application/json",
                data: { sGrpCode: selectedGrpCode, sStaffId: vStaffId },
                catch: false,
                success: function (data) {
                   alert("After ALR Loads");
                    $('#myModalContent').html(data);
                    $('#myModal').modal(options);
                    $('#myModal').modal('show');

                },
                error: function () {
                    alert("Dynamic content load failed.");
                }
            });
        });
        //$("#closebtn").on('click',function(){  
        //    $('#myModal').modal('hide');    

        $("#closbtn").click(function () {
            $('#myModal').modal('hide');
        });
    });*@




    // Check Box Select 
    $('#btnSelectAll').click(function () {
        if ($(this).hasClass('allChecked')) {
            $('input[class="LPost"]', '#LoanColstbl').prop('checked', false);
        } else {
            $('input[class="LPost"]', '#LoanColstbl').prop('checked', true);
        }
        $(this).toggleClass('allChecked');


        var LoanIds = '';
        $('table [type="checkbox"]').each(function (i, chk) {
            if (chk.checked) {
                LoanIds += "/" + $(this).val();
            }
        });
        $("#PrepaidLoanIds").val(LoanIds);
    });

    $('#btnSelectAllPre').click(function () {
        if ($(this).hasClass('allChecked')) {
            $('input[class="LPre"]', '#LoanColstbl').prop('checked', false);
        } else {
            $('input[class="LPre"]', '#LoanColstbl').prop('checked', true);
        }
        $(this).toggleClass('allChecked');


        var LoanIds = '';
        $('table [type="checkbox"]').each(function (i, chk) {
            if (chk.checked) {
                LoanIds += "/" + $(this).val();
                if ($(this).val().trim().split(',')[0] == 'PrePaid') {
                    $('#tdBL' + $(this).val().split(',')[1]).val($('#tdBL' + $(this).val().split(',')[1]).text()) // tdBL = Bal Amt
                    $('#tdCD' + $(this).val().split(',')[1]).val($('#tdCD' + $(this).val().split(',')[1]).text());


                    $('#tdCD' + $(this).val().split(',')[1]).text($('#tdBL' + $(this).val().split(',')[1]).text()); // tdCD = Current Due
                    $('#tdCD' + $(this).val().split(',')[1]).text($('#tdLA' + $(this).val().split(',')[1]).text());  // tdLA = Loan Amt
                    $('#tdBL' + $(this).val().split(',')[1]).text("0.00");



                }
            }
            else if (!chk.checked) {
                if ($(this).val().trim().split(',')[0] == 'PrePaid') {
                    $('#tdCD' + $(this).val().split(',')[1]).text($('#tdCD' + $(this).val().split(',')[1]).val());
                    $('#tdBL' + $(this).val().split(',')[1]).text($('#tdBL' + $(this).val().split(',')[1]).val());


                }
            }
        });
        $("#PrepaidLoanIds").val(LoanIds);
    });


    function SwapValForPrePaid(Input) {
        debugger;
        if (Input.checked) {
            $('#tdBL' + Input.value.split(',')[1]).val($('#tdBL' + Input.value.split(',')[1]).text())
            $('#tdCD' + Input.value.split(',')[1]).val($('#tdCD' + Input.value.split(',')[1]).text());


            $('#tdCD' + Input.value.split(',')[1]).text($('#tdBL' + Input.value.split(',')[1]).text());
            $('#tdCD' + Input.value.split(',')[1]).text($('#tdLA' + Input.value.split(',')[1]).text());
            $('#tdBL' + Input.value.split(',')[1]).text("0.00");

            //var sRemainingBal = Math.round(parseFloat($('#tdCD' + Input.value.split(',')[1]).text()) - parseFloat($('#tdNtSvg' + Input.value.split(',')[1]).text()));
            var sRemainingBal = Math.round(parseFloat($('#tdCD' + Input.value.split(',')[1]).text()) - parseFloat(0));

            if (parseInt(sRemainingBal) < 0) {
                alert("You have to refund : " + sRemainingBal + " Rs to member.");
                sRemainingBal = sRemainingBal;
            }
            else {
                alert("You have to collect : " + sRemainingBal + " Rs from member.");
                sRemainingBal = "+" + sRemainingBal;
            }


            //$('#txtAdjst' + Input.value.split(',')[1]).val(sRemainingBal);
            //$('#txtAdjst' + Input.value.split(',')[1]).val(Math.round(parseFloat($('#tdCD' + Input.value.split(',')[1]).text()) - parseFloat($('#tdNtSvg' + Input.value.split(',')[1]).text())));
            //$('#txtAdjst' + Input.value.split(',')[1]).attr('disabled', false);
        }
        else {
            $('#tdCD' + Input.value.split(',')[1]).text($('#tdCD' + Input.value.split(',')[1]).val());
            $('#tdBL' + Input.value.split(',')[1]).text($('#tdBL' + Input.value.split(',')[1]).val());
            //$('#txtAdjst' + Input.value.split(',')[1]).val("0.00");
            //$('#txtAdjst' + Input.value.split(',')[1]).attr('disabled', true);
        }

    }

    $("#btnPrint").click(function () {
        $("#lblStaff").html($("#StaffId :selected").text());
        $('#pStaffName').attr("style", "display:normal");


        var mode = 'iframe';
        var close = mode == "popup";
        var options = { mode: mode, popClose: close };
        $("#dvDailyreportData").printArea(options);
    }) 

    function LoanPosting() {
        var LoanId = '', MbrId = '',
        LoanAmount = '',
        PaidInstallments = '',
        PaidAmount = '',
        BalanceAmount = '',
        BalanceInstallment = '',
        CurrentDue = '',
        DuringSavings = '',
        Savings = '',
        PrevLoanID = '';
        sPostType = '';
        sAdjustment = '';
        //$('table [type="checkbox"]').each(function (i, chk) {
        //            if (chk.checked) {
        //                LoanId += "/" + $(this).val() + "," + $('#txt' + $(this).val().trim().split(',')[1]).val();
        //            }

        //        }) ;  

        $('table [type="checkbox"]').each(function (i, chk) {
            if (chk.checked) {

                if (chk.value.split(',')[1].trim() != PrevLoanID) {
                    LoanId = $('#tdID' + $(this).val().trim().split(',')[1]).text();
                    LoanAmount = $('#tdLA' + $(this).val().trim().split(',')[1]).text();
                    PaidInstallments = $('#tdPE' + $(this).val().trim().split(',')[1]).text();
                    PaidAmount = $('#tdCA' + $(this).val().trim().split(',')[1]).text();
                    BalanceAmount = $('#tdBL' + $(this).val().trim().split(',')[1]).text();
                    CurrentDue = $('#tdCD' + $(this).val().trim().split(',')[1]).text();
                    Savings = 0;// $('#txt' + $(this).val().trim().split(',')[1]).val();

                    sAdjustment = 0;// $('#txtAdjst' + $(this).val().trim().split(',')[1]).val();

                    if ($('#ck' + $(this).val().trim().split(',')[1]).is(':checked')) {
                        sPostType = $('#ck' + $(this).val().trim().split(',')[1]).val().split(',')[0];
                        CurrentDue = LoanAmount;
                    }

                    $.ajax({
                        url: '@Url.Action("LoanPosting", "Loans")',
                        type: "Get",
                        contentType: "application/json",
                        data: {
                            sPostType: sPostType,
                            LoanId: LoanId, LoanAmount: LoanAmount,
                            PaidInstallments: PaidInstallments, PaidAmount: PaidAmount,
                            BalanceAmount: BalanceAmount, CurrentDue: CurrentDue,
                            Savings: Savings, sAdjustment: sAdjustment
                        },
                        catch: false,
                        success: function (result) {
                            if (result.trim() == "NoAdj") {
                                if (alert("No sufficient savings balance in this account")) {
                                    loadData();
                                }
                                else {
                                    loadData();
                                }
                            }
                            else if (result.trim() == "1") {
                                alert("Successfully Posted.")
                                loadData();
                            }
                        },
                        error: function (errormessage) {
                            alert("Error while process your request");
                        }
                    });
                    PrevLoanID = LoanId;
                }
            }

        });
    }
</script>


